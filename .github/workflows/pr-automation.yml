name: Pull Request Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      - name: Run ESLint
        id: eslint
        run: |
          echo "Running ESLint checks..."
          npm run lint > eslint-results.txt 2>&1 || true
          if [ $? -eq 0 ]; then
            echo "eslint_status=‚úÖ Passed" >> $GITHUB_OUTPUT
            echo "eslint_message=No linting errors found" >> $GITHUB_OUTPUT
          else
            echo "eslint_status=‚ùå Failed" >> $GITHUB_OUTPUT
            echo "eslint_message=Linting errors detected" >> $GITHUB_OUTPUT
          fi
          cat eslint-results.txt
        continue-on-error: true

      - name: Run Prettier check
        id: prettier
        run: |
          echo "Running Prettier formatting checks..."
          npx prettier --check "src/**/*.js" > prettier-results.txt 2>&1 || true
          if [ $? -eq 0 ]; then
            echo "prettier_status=‚úÖ Passed" >> $GITHUB_OUTPUT
            echo "prettier_message=All files are properly formatted" >> $GITHUB_OUTPUT
          else
            echo "prettier_status=‚ùå Failed" >> $GITHUB_OUTPUT
            echo "prettier_message=Formatting issues detected" >> $GITHUB_OUTPUT
          fi
          cat prettier-results.txt
        continue-on-error: true

      - name: Post Code Quality Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            
            let eslintResults = '';
            let prettierResults = '';
            
            try {
              eslintResults = fs.readFileSync('eslint-results.txt', 'utf8');
            } catch (e) {
              eslintResults = 'No ESLint output available';
            }
            
            try {
              prettierResults = fs.readFileSync('prettier-results.txt', 'utf8');
            } catch (e) {
              prettierResults = 'No Prettier output available';
            }
            
            const eslintStatus = '${{ steps.eslint.outputs.eslint_status }}' || '‚ö†Ô∏è Unknown';
            const prettierStatus = '${{ steps.prettier.outputs.prettier_status }}' || '‚ö†Ô∏è Unknown';
            
            const comment = `## üìã Code Quality Report
            
            **Workflow Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            **Commit:** ${context.sha.substring(0, 7)}
            
            ### ESLint Results
            **Status:** ${eslintStatus}
            
            <details>
            <summary>View ESLint Details</summary>
            
            \`\`\`
            ${eslintResults.substring(0, 2000)}
            \`\`\`
            
            </details>
            
            ### Prettier Results
            **Status:** ${prettierStatus}
            
            <details>
            <summary>View Prettier Details</summary>
            
            \`\`\`
            ${prettierResults.substring(0, 2000)}
            \`\`\`
            
            </details>
            
            ---
            *This report was automatically generated by the PR automation workflow*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

  testing-suite:
    name: Test Suite Execution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      - name: Run test suite with coverage
        id: tests
        run: |
          echo "Running full test suite..."
          npm run test:coverage > test-results.txt 2>&1 || true
          TEST_EXIT_CODE=$?
          
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "test_status=‚úÖ Passed" >> $GITHUB_OUTPUT
            echo "test_message=All tests passed successfully" >> $GITHUB_OUTPUT
          else
            echo "test_status=‚ùå Failed" >> $GITHUB_OUTPUT
            echo "test_message=Some tests failed" >> $GITHUB_OUTPUT
          fi
          
          cat test-results.txt
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Extract coverage summary
        id: coverage
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "Coverage summary found"
            LINES=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
            
            echo "lines=$LINES" >> $GITHUB_OUTPUT
            echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          else
            echo "No coverage summary found"
            echo "lines=0" >> $GITHUB_OUTPUT
            echo "statements=0" >> $GITHUB_OUTPUT
            echo "functions=0" >> $GITHUB_OUTPUT
            echo "branches=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage-report
          path: coverage/
          retention-days: 30

      - name: Post Test Coverage Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            
            let testResults = '';
            try {
              testResults = fs.readFileSync('test-results.txt', 'utf8');
            } catch (e) {
              testResults = 'No test results available';
            }
            
            const testStatus = '${{ steps.tests.outputs.test_status }}' || '‚ö†Ô∏è Unknown';
            const lines = '${{ steps.coverage.outputs.lines }}' || 'N/A';
            const statements = '${{ steps.coverage.outputs.statements }}' || 'N/A';
            const functions = '${{ steps.coverage.outputs.functions }}' || 'N/A';
            const branches = '${{ steps.coverage.outputs.branches }}' || 'N/A';
            
            const comment = `## üß™ Test Coverage Report
            
            **Workflow Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            **Commit:** ${context.sha.substring(0, 7)}
            **Status:** ${testStatus}
            
            ### Coverage Summary
            
            | Metric | Coverage |
            |--------|----------|
            | **Lines** | ${lines}% |
            | **Statements** | ${statements}% |
            | **Functions** | ${functions}% |
            | **Branches** | ${branches}% |
            
            <details>
            <summary>View Test Results</summary>
            
            \`\`\`
            ${testResults.substring(0, 3000)}
            \`\`\`
            
            </details>
            
            ---
            *Coverage artifacts have been uploaded and will be retained for 30 days*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      - name: Run npm audit for dependency vulnerabilities
        id: npm-audit
        run: |
          echo "Running dependency vulnerability checks..."
          npm audit --json > audit-results.json 2>&1 || true
          
          if [ -f audit-results.json ]; then
            VULNERABILITIES=$(jq -r '.metadata.vulnerabilities | to_entries | map("\(.key): \(.value)") | join(", ")' audit-results.json 2>/dev/null || echo "Unable to parse")
            TOTAL=$(jq -r '.metadata.vulnerabilities.total // 0' audit-results.json 2>/dev/null || echo "0")
            
            echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            
            if [ "$TOTAL" -eq 0 ]; then
              echo "audit_status=‚úÖ No vulnerabilities found" >> $GITHUB_OUTPUT
            else
              echo "audit_status=‚ö†Ô∏è $TOTAL vulnerabilities detected" >> $GITHUB_OUTPUT
            fi
          else
            echo "audit_status=‚ö†Ô∏è Unable to run audit" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Scan for secrets in code changes
        id: secret-scan
        run: |
          echo "Scanning for potential secrets in code changes..."
          
          # Create a simple secret scanner
          SECRET_PATTERNS=(
            "password.*=.*['\"].*['\"]"
            "api[_-]?key.*=.*['\"].*['\"]"
            "secret.*=.*['\"].*['\"]"
            "token.*=.*['\"].*['\"]"
            "private[_-]?key"
            "aws[_-]?access"
            "sk_live_"
            "pk_live_"
          )
          
          SECRETS_FOUND=0
          SECRET_FILES=""
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if git diff origin/${{ github.base_ref }} --name-only | xargs grep -i -E "$pattern" 2>/dev/null; then
              SECRETS_FOUND=$((SECRETS_FOUND + 1))
              SECRET_FILES="${SECRET_FILES}\n- Pattern matched: $pattern"
            fi
          done
          
          if [ $SECRETS_FOUND -eq 0 ]; then
            echo "secret_status=‚úÖ No secrets detected" >> $GITHUB_OUTPUT
            echo "secret_count=0" >> $GITHUB_OUTPUT
          else
            echo "secret_status=‚ö†Ô∏è Potential secrets found" >> $GITHUB_OUTPUT
            echo "secret_count=$SECRETS_FOUND" >> $GITHUB_OUTPUT
          fi
          
          echo "secret_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SECRET_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate dependency report
        id: deps-report
        run: |
          echo "Generating Dependencies report..."
          npm list --depth=0 --json > dependencies.json 2>&1 || true
          
          if [ -f dependencies.json ]; then
            DEP_COUNT=$(jq -r '.dependencies | length' dependencies.json 2>/dev/null || echo "0")
            echo "dependency_count=$DEP_COUNT" >> $GITHUB_OUTPUT
          else
            echo "dependency_count=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Post Security Scan Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            
            const auditStatus = '${{ steps.npm-audit.outputs.audit_status }}' || '‚ö†Ô∏è Unknown';
            const vulnTotal = '${{ steps.npm-audit.outputs.total }}' || '0';
            const vulnDetails = '${{ steps.npm-audit.outputs.vulnerabilities }}' || 'None';
            const secretStatus = '${{ steps.secret-scan.outputs.secret_status }}' || '‚ö†Ô∏è Unknown';
            const secretCount = '${{ steps.secret-scan.outputs.secret_count }}' || '0';
            const depCount = '${{ steps.deps-report.outputs.dependency_count }}' || 'N/A';
            
            let auditJson = '';
            try {
              const audit = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
              if (audit.vulnerabilities) {
                const vulnList = Object.entries(audit.vulnerabilities)
                  .slice(0, 10)
                  .map(([name, details]) => `- **${name}**: ${details.severity || 'unknown'}`)
                  .join('\n');
                auditJson = vulnList || 'No specific vulnerabilities listed';
              } else {
                auditJson = 'No vulnerabilities data available';
              }
            } catch (e) {
              auditJson = 'Unable to parse audit results';
            }
            
            const comment = `## üîí Security Scan Report
            
            **Workflow Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            **Commit:** ${context.sha.substring(0, 7)}
            
            ### Vulnerability Scan
            **Status:** ${auditStatus}
            **Total Vulnerabilities:** ${vulnTotal}
            
            <details>
            <summary>View Vulnerabilities Details</summary>
            
            ${auditJson}
            
            </details>
            
            ### Secret Detection
            **Status:** ${secretStatus}
            **Potential Secrets:** ${secretCount}
            
            ### Dependencies Analysis
            **Total Dependencies:** ${depCount}
            
            ${vulnTotal > 0 ? '‚ö†Ô∏è **Action Required:** Please review and address the security vulnerabilities before merging.' : '‚úÖ No security issues detected.'}
            
            ---
            *This security scan was automatically generated by the PR automation workflow*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

  build-validation:
    name: Build and Deployment Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      - name: Build application
        id: build
        run: |
          echo "Building application..."
          npm run build > build-output.txt 2>&1
          BUILD_EXIT_CODE=$?
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "build_status=‚úÖ Build successful" >> $GITHUB_OUTPUT
            echo "build_message=Application built successfully" >> $GITHUB_OUTPUT
          else
            echo "build_status=‚ùå Build failed" >> $GITHUB_OUTPUT
            echo "build_message=Build process encountered errors" >> $GITHUB_OUTPUT
          fi
          
          cat build-output.txt
        continue-on-error: true

      - name: Start application in background
        id: start-app
        run: |
          echo "Starting application..."
          npm start > app-logs.txt 2>&1 &
          APP_PID=$!
          echo "app_pid=$APP_PID" >> $GITHUB_OUTPUT
          
          # Wait for app to start
          echo "Waiting for application to start..."
          sleep 5
          
          if ps -p $APP_PID > /dev/null; then
            echo "app_status=‚úÖ Running" >> $GITHUB_OUTPUT
          else
            echo "app_status=‚ùå Failed to start" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Validate endpoints
        id: validate
        run: |
          echo "Validating application endpoints..."
          
          ENDPOINTS=(
            "/health:Health Check"
            "/api/status:Status"
            "/:Root"
          )
          
          VALIDATION_RESULTS=""
          PASSED=0
          FAILED=0
          
          for endpoint_info in "${ENDPOINTS[@]}"; do
            IFS=':' read -r endpoint name <<< "$endpoint_info"
            
            echo "Testing $name endpoint ($endpoint)..."
            if curl -f -s http://localhost:3000$endpoint > /dev/null 2>&1; then
              VALIDATION_RESULTS="${VALIDATION_RESULTS}\n‚úÖ $name: Accessible"
              PASSED=$((PASSED + 1))
            else
              VALIDATION_RESULTS="${VALIDATION_RESULTS}\n‚ùå $name: Not accessible"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo "validation_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VALIDATION_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          
          if [ $FAILED -eq 0 ]; then
            echo "validation_status=‚úÖ All endpoints accessible" >> $GITHUB_OUTPUT
          else
            echo "validation_status=‚ö†Ô∏è Some endpoints failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Stop application
        if: always()
        run: |
          if [ -n "${{ steps.start-app.outputs.app_pid }}" ]; then
            kill ${{ steps.start-app.outputs.app_pid }} 2>/dev/null || true
          fi
          pkill -f "node src/app.js" || true

      - name: Create deployment preview artifacts
        if: always()
        run: |
          mkdir -p preview-artifacts
          
          # Copy important files
          cp package.json preview-artifacts/ 2>/dev/null || true
          cp build-output.txt preview-artifacts/ 2>/dev/null || true
          cp app-logs.txt preview-artifacts/ 2>/dev/null || true
          
          # Create build info
          cat > preview-artifacts/build-info.txt << EOF
          Build Information
          ==================
          Commit: ${GITHUB_SHA:0:7}
          Branch: ${GITHUB_HEAD_REF}
          Triggered by: ${GITHUB_ACTOR}
          Workflow: ${GITHUB_WORKFLOW}
          Run Number: ${GITHUB_RUN_NUMBER}
          Build Time: $(date -u)
          EOF
          
          echo "‚úÖ Preview artifacts created"

      - name: Upload deployment preview
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-preview
          path: preview-artifacts/
          retention-days: 7

      - name: Post Build Validation Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            
            const buildStatus = '${{ steps.build.outputs.build_status }}' || '‚ö†Ô∏è Unknown';
            const appStatus = '${{ steps.start-app.outputs.app_status }}' || '‚ö†Ô∏è Unknown';
            const validationStatus = '${{ steps.validate.outputs.validation_status }}' || '‚ö†Ô∏è Unknown';
            const passed = '${{ steps.validate.outputs.passed }}' || '0';
            const failed = '${{ steps.validate.outputs.failed }}' || '0';
            
            let buildOutput = '';
            try {
              buildOutput = fs.readFileSync('build-output.txt', 'utf8');
            } catch (e) {
              buildOutput = 'No build output available';
            }
            
            let appLogs = '';
            try {
              appLogs = fs.readFileSync('app-logs.txt', 'utf8');
            } catch (e) {
              appLogs = 'No application logs available';
            }
            
            const validationResults = `${{ steps.validate.outputs.validation_results }}` || 'No validation results';
            
            const comment = `## üèóÔ∏è Build Validation Report
            
            **Workflow Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            **Commit:** ${context.sha.substring(0, 7)}
            
            ### Build Status
            **Status:** ${buildStatus}
            
            <details>
            <summary>View Build Output</summary>
            
            \`\`\`
            ${buildOutput.substring(0, 1500)}
            \`\`\`
            
            </details>
            
            ### Application Status
            **Status:** ${appStatus}
            
            ### Endpoint Validation
            **Status:** ${validationStatus}
            **Passed:** ${passed} | **Failed:** ${failed}
            
            ${validationResults}
            
            <details>
            <summary>View Application Logs</summary>
            
            \`\`\`
            ${appLogs.substring(0, 1500)}
            \`\`\`
            
            </details>
            
            ### Deployment Preview
            Deployment preview artifacts have been created and uploaded for review.
            
            ---
            *This build validation was automatically generated by the PR automation workflow*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
